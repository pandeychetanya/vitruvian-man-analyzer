<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vitruvian Man Analyzer</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Crimson+Text:wght@400;600&family=Cormorant+Garamond:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cormorant Garamond', serif;
            line-height: 1.7;
            color: #2c1810;
            background: linear-gradient(135deg, 
                #f4f1ec 0%, 
                #ede4d3 25%, 
                #e8dcc0 50%, 
                #d4c4a8 75%, 
                #c9b896 100%
            );
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="paper" patternUnits="userSpaceOnUse" width="100" height="100"><rect fill="%23f8f5f0" width="100" height="100"/><g opacity="0.1"><circle cx="20" cy="20" r="1" fill="%23d4af37"/><circle cx="80" cy="40" r="0.5" fill="%238b4513"/><circle cx="30" cy="70" r="0.8" fill="%23cd853f"/><circle cx="70" cy="80" r="1.2" fill="%23daa520"/><circle cx="50" cy="30" r="0.3" fill="%23b8860b"/><circle cx="10" cy="90" r="0.7" fill="%23d2691e"/></g></pattern></defs><rect width="100" height="100" fill="url(%23paper)"/></svg>') repeat;
            opacity: 0.3;
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
            position: relative;
        }

        header {
            text-align: center;
            margin-bottom: 60px;
            padding: 40px 0;
            position: relative;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 3px;
            background: linear-gradient(90deg, transparent 0%, #d4af37 20%, #b8860b 50%, #d4af37 80%, transparent 100%);
            border-radius: 2px;
        }

        header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 3px;
            background: linear-gradient(90deg, transparent 0%, #d4af37 20%, #b8860b 50%, #d4af37 80%, transparent 100%);
            border-radius: 2px;
        }

        header h1 {
            font-family: 'Cinzel', serif;
            font-size: 3.5em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #8b4513;
            text-shadow: 2px 2px 4px rgba(139, 69, 19, 0.1);
            letter-spacing: 2px;
        }

        header p {
            font-size: 1.4em;
            color: #6b4423;
            font-style: italic;
            font-weight: 400;
        }

        .subtitle {
            font-family: 'Crimson Text', serif;
            font-size: 1.1em;
            color: #8b6f47;
            margin-top: 10px;
            font-style: italic;
        }

        main {
            background: linear-gradient(145deg, 
                rgba(255, 255, 255, 0.95) 0%, 
                rgba(248, 245, 240, 0.9) 50%, 
                rgba(255, 255, 255, 0.95) 100%
            );
            border-radius: 20px;
            padding: 50px;
            box-shadow: 
                0 25px 50px rgba(139, 69, 19, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8),
                0 0 0 1px rgba(212, 175, 55, 0.1);
            margin-bottom: 50px;
            backdrop-filter: blur(10px);
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
        }

        main::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 15px;
            pointer-events: none;
        }

        .upload-section {
            margin-bottom: 50px;
        }

        .upload-area {
            border: 3px dashed #d4af37;
            border-radius: 20px;
            padding: 70px 50px;
            text-align: center;
            background: linear-gradient(145deg, 
                rgba(248, 245, 240, 0.8) 0%, 
                rgba(255, 252, 247, 0.9) 50%, 
                rgba(248, 245, 240, 0.8) 100%
            );
            transition: all 0.4s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, 
                #d4af37 0%, 
                #b8860b 25%, 
                #cd853f 50%, 
                #daa520 75%, 
                #d4af37 100%
            );
            border-radius: 20px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .upload-area:hover::before {
            opacity: 0.3;
        }

        .upload-area:hover {
            border-color: #b8860b;
            background: linear-gradient(145deg, 
                rgba(255, 252, 247, 0.95) 0%, 
                rgba(248, 245, 240, 0.9) 50%, 
                rgba(255, 252, 247, 0.95) 100%
            );
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 35px rgba(139, 69, 19, 0.15);
        }

        .upload-area.dragover {
            border-color: #8b4513;
            background: linear-gradient(145deg, 
                rgba(212, 175, 55, 0.1) 0%, 
                rgba(255, 252, 247, 0.95) 50%, 
                rgba(212, 175, 55, 0.1) 100%
            );
            transform: scale(1.05);
            box-shadow: 0 20px 40px rgba(139, 69, 19, 0.2);
        }

        .upload-icon {
            font-size: 5em;
            margin-bottom: 25px;
            color: #d4af37;
            text-shadow: 2px 2px 4px rgba(212, 175, 55, 0.2);
        }

        .upload-content p {
            font-family: 'Crimson Text', serif;
            font-size: 1.4em;
            margin-bottom: 25px;
            color: #6b4423;
            font-weight: 600;
        }

        .upload-btn {
            background: linear-gradient(135deg, #d4af37 0%, #b8860b 50%, #8b4513 100%);
            color: #fff;
            border: none;
            padding: 18px 40px;
            font-family: 'Cinzel', serif;
            font-size: 1.1em;
            font-weight: 500;
            letter-spacing: 1px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.4s ease;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }

        .upload-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
            transition: left 0.5s ease;
        }

        .upload-btn:hover::before {
            left: 100%;
        }

        .upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(139, 69, 19, 0.3);
            background: linear-gradient(135deg, #daa520 0%, #cd853f 50%, #a0522d 100%);
        }

        .analysis-section {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 50px;
            align-items: start;
        }

        .image-preview {
            position: relative;
        }

        .image-preview img {
            width: 100%;
            height: auto;
            border-radius: 15px;
            box-shadow: 
                0 20px 40px rgba(139, 69, 19, 0.2),
                0 0 0 3px rgba(212, 175, 55, 0.1),
                inset 0 0 0 1px rgba(255, 255, 255, 0.5);
            border: 2px solid rgba(212, 175, 55, 0.3);
        }

        .image-preview::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(45deg, #d4af37, #b8860b, #cd853f, #daa520);
            border-radius: 20px;
            z-index: -1;
            opacity: 0.1;
        }

        .results {
            display: flex;
            flex-direction: column;
            gap: 35px;
        }

        .score-display {
            text-align: center;
            padding: 30px;
            background: linear-gradient(145deg, 
                rgba(212, 175, 55, 0.05) 0%, 
                rgba(255, 255, 255, 0.8) 50%, 
                rgba(212, 175, 55, 0.05) 100%
            );
            border-radius: 20px;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        .score-circle {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: linear-gradient(135deg, #d4af37 0%, #b8860b 30%, #8b4513 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 25px;
            color: #fff;
            font-weight: bold;
            box-shadow: 
                0 15px 30px rgba(139, 69, 19, 0.3),
                inset 0 2px 4px rgba(255, 255, 255, 0.2),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .score-circle::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            bottom: 8px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
        }

        .score-circle span {
            font-family: 'Cinzel', serif;
            font-size: 2.2em;
            line-height: 1;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .score-circle small {
            font-size: 0.9em;
            opacity: 0.9;
            font-family: 'Cormorant Garamond', serif;
        }

        #scoreLevel {
            font-family: 'Cinzel', serif;
            font-size: 1.8em;
            margin: 0;
            color: #8b4513;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .metrics {
            display: flex;
            flex-direction: column;
            gap: 25px;
            padding: 30px;
            background: linear-gradient(145deg, 
                rgba(248, 245, 240, 0.6) 0%, 
                rgba(255, 255, 255, 0.8) 50%, 
                rgba(248, 245, 240, 0.6) 100%
            );
            border-radius: 18px;
            border: 1px solid rgba(212, 175, 55, 0.15);
            box-shadow: 0 10px 25px rgba(139, 69, 19, 0.08);
        }

        .metric {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .metric label {
            font-family: 'Cinzel', serif;
            font-weight: 600;
            color: #8b4513;
            font-size: 1.1em;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .metric-bar {
            background: linear-gradient(135deg, 
                rgba(212, 175, 55, 0.1) 0%, 
                rgba(139, 69, 19, 0.05) 100%
            );
            border-radius: 12px;
            height: 24px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(212, 175, 55, 0.2);
            box-shadow: inset 0 2px 4px rgba(139, 69, 19, 0.1);
        }

        .metric-fill {
            height: 100%;
            background: linear-gradient(135deg, #d4af37 0%, #b8860b 50%, #8b4513 100%);
            border-radius: 12px;
            transition: width 1s ease;
            width: 0%;
            position: relative;
            box-shadow: 
                inset 0 1px 2px rgba(255, 255, 255, 0.3),
                0 1px 3px rgba(139, 69, 19, 0.2);
        }

        .metric-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, 
                rgba(255, 255, 255, 0.2) 0%, 
                transparent 100%
            );
            border-radius: 12px 12px 0 0;
        }

        .metric-bar span {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.95em;
            font-weight: 600;
            color: #6b4423;
            font-family: 'Cormorant Garamond', serif;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        .analysis-text {
            background: linear-gradient(145deg, 
                rgba(248, 245, 240, 0.9) 0%, 
                rgba(255, 252, 247, 0.95) 50%, 
                rgba(248, 245, 240, 0.9) 100%
            );
            padding: 30px;
            border-radius: 15px;
            border-left: 5px solid #d4af37;
            border-top: 1px solid rgba(212, 175, 55, 0.3);
            border-right: 1px solid rgba(212, 175, 55, 0.3);
            border-bottom: 1px solid rgba(212, 175, 55, 0.3);
            white-space: pre-line;
            font-family: 'Crimson Text', serif;
            font-size: 1.05em;
            line-height: 1.7;
            color: #4a3626;
            box-shadow: 
                0 10px 25px rgba(139, 69, 19, 0.1),
                inset 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        .detailed-analysis {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid rgba(212, 175, 55, 0.3);
            font-style: italic;
            color: #6b4423;
        }

        .new-analysis-btn {
            background: linear-gradient(135deg, #8b4513 0%, #a0522d 50%, #654321 100%);
            color: #fff;
            border: none;
            padding: 18px 40px;
            font-family: 'Cinzel', serif;
            font-size: 1.1em;
            font-weight: 500;
            letter-spacing: 1px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.4s ease;
            align-self: center;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }

        .new-analysis-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.2) 50%, transparent 100%);
            transition: left 0.5s ease;
        }

        .new-analysis-btn:hover::before {
            left: 100%;
        }

        .new-analysis-btn:hover {
            background: linear-gradient(135deg, #a0522d 0%, #8b4513 50%, #654321 100%);
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(139, 69, 19, 0.4);
        }

        .loading {
            text-align: center;
            padding: 80px 50px;
        }

        .spinner {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(212, 175, 55, 0.2);
            border-top: 4px solid #d4af37;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            margin: 0 auto 30px;
        }

        .loading p {
            font-family: 'Crimson Text', serif;
            font-size: 1.3em;
            color: #8b4513;
            font-style: italic;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-section {
            background: linear-gradient(145deg, 
                rgba(139, 69, 19, 0.8) 0%, 
                rgba(160, 82, 45, 0.9) 50%, 
                rgba(139, 69, 19, 0.8) 100%
            );
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 50px;
            color: #fff;
            text-align: center;
            border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 0 20px 40px rgba(139, 69, 19, 0.2);
            position: relative;
            overflow: hidden;
        }

        .info-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, #d4af37 50%, transparent 100%);
        }

        .info-section h3 {
            font-family: 'Cinzel', serif;
            font-size: 2em;
            margin-bottom: 25px;
            color: #f4f1ec;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .info-section p {
            font-family: 'Cormorant Garamond', serif;
            opacity: 0.95;
            line-height: 1.8;
            max-width: 900px;
            margin: 0 auto;
            font-size: 1.15em;
        }

        .error-message {
            background: linear-gradient(135deg, 
                rgba(220, 53, 69, 0.1) 0%, 
                rgba(248, 215, 218, 0.9) 50%, 
                rgba(220, 53, 69, 0.1) 100%
            );
            color: #721c24;
            padding: 20px 25px;
            border-radius: 15px;
            margin: 25px 0;
            border: 1px solid #f5c6cb;
            font-family: 'Crimson Text', serif;
            font-size: 1.1em;
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.1);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            header h1 {
                font-size: 2em;
            }
            
            main {
                padding: 20px;
            }
            
            .analysis-section {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .upload-area {
                padding: 40px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Vitruvian Man Analyzer</h1>
            <p>Analyze human poses using Leonardo da Vinci's perfect proportions</p>
            <div class="subtitle">~  A Renaissance Journey Through Digital Mathematics  ~</div>
        </header>

        <main>
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-content">
                        <div class="upload-icon">📷</div>
                        <p>Drop an image here or click to select</p>
                        <input type="file" id="imageInput" accept="image/*" hidden>
                        <button class="upload-btn" onclick="document.getElementById('imageInput').click()">
                            Select Image
                        </button>
                    </div>
                </div>
            </div>

            <div class="analysis-section" id="analysisSection" style="display: none;">
                <div class="image-preview">
                    <img id="previewImage" alt="Uploaded image">
                </div>
                
                <div class="results">
                    <div class="score-display">
                        <div class="score-circle">
                            <span id="scoreValue">--</span>
                            <small>/100</small>
                        </div>
                        <h3 id="scoreLevel">Analyzing...</h3>
                    </div>
                    
                    <div class="metrics">
                        <div class="metric">
                            <label>Head to Height Ratio</label>
                            <div class="metric-bar">
                                <div class="metric-fill" id="headRatio"></div>
                                <span id="headRatioText">--</span>
                            </div>
                        </div>
                        
                        <div class="metric">
                            <label>Arm Span to Height</label>
                            <div class="metric-bar">
                                <div class="metric-fill" id="armSpan"></div>
                                <span id="armSpanText">--</span>
                            </div>
                        </div>
                        
                        <div class="metric">
                            <label>Symmetry Score</label>
                            <div class="metric-bar">
                                <div class="metric-fill" id="symmetry"></div>
                                <span id="symmetryText">--</span>
                            </div>
                        </div>
                        
                        <div class="metric">
                            <label>Square Fit Ratio</label>
                            <div class="metric-bar">
                                <div class="metric-fill" id="squareFit"></div>
                                <span id="squareFitText">--</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analysis-text" id="analysisText">
                        <!-- Analysis details will be populated here -->
                    </div>
                    
                    <button class="new-analysis-btn" onclick="resetAnalysis()">
                        Analyze Another Image
                    </button>
                </div>
            </div>

            <div class="loading" id="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Analyzing pose and proportions...</p>
            </div>

            <div id="errorMessage" class="error-message" style="display: none;">
                <!-- Error messages will appear here -->
            </div>
        </main>

        <footer>
            <div class="info-section">
                <h3>About the Vitruvian Man</h3>
                <p>
                    Leonardo da Vinci's Vitruvian Man represents the ideal human body proportions 
                    based on the correlations of ideal human body proportions with geometry described 
                    by the ancient Roman architect Vitruvius. This analyzer uses AI to measure how 
                    closely a human pose matches these classical proportions.
                </p>
            </div>
        </footer>
    </div>

    <!-- TensorFlow.js and PoseNet -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet@2.2.2"></script>

    <script>
        let net;
        let isModelLoaded = false;

        // Load PoseNet model
        async function loadModel() {
            try {
                net = await posenet.load({
                    architecture: 'MobileNetV1',
                    outputStride: 16,
                    inputResolution: { width: 640, height: 480 },
                    multiplier: 0.75
                });
                isModelLoaded = true;
                console.log('PoseNet model loaded successfully');
            } catch (error) {
                console.error('Error loading PoseNet model:', error);
                showError('Failed to load AI model. Please refresh the page and try again.');
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadModel();
            setupEventHandlers();
        });

        function setupEventHandlers() {
            const uploadArea = document.getElementById('uploadArea');
            const imageInput = document.getElementById('imageInput');

            // Upload area click handler
            uploadArea.addEventListener('click', function() {
                imageInput.click();
            });

            // Drag and drop handlers
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleImageUpload(files[0]);
                }
            });

            // File input change handler
            imageInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleImageUpload(e.target.files[0]);
                }
            });
        }

        async function handleImageUpload(file) {
            if (!isModelLoaded) {
                showError('AI model is still loading. Please wait a moment and try again.');
                return;
            }

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showError('Please select a valid image file.');
                return;
            }

            showLoading();

            try {
                // Create image element
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                img.onload = async function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    try {
                        // Perform pose estimation
                        const poses = await net.estimateSinglePose(canvas, {
                            flipHorizontal: false
                        });

                        if (poses && poses.keypoints) {
                            const analysis = analyzeVitruvianPose(poses.keypoints, img.width, img.height);
                            displayResults(analysis);
                        } else {
                            throw new Error('No pose detected in the image');
                        }
                    } catch (error) {
                        console.error('Pose estimation error:', error);
                        showError('Could not detect a human pose in this image. Please try with a clearer full-body image.');
                    }
                };

                img.onerror = function() {
                    showError('Could not load the selected image. Please try a different file.');
                };

                // Preview image
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImage').src = e.target.result;
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);

            } catch (error) {
                console.error('Error processing image:', error);
                showError('Error processing the image. Please try again.');
            }
        }

        function analyzeVitruvianPose(keypoints, imageWidth, imageHeight) {
            // Extract key body points
            const bodyPoints = extractBodyPoints(keypoints);
            
            // Calculate proportions
            const proportions = calculateProportions(bodyPoints);
            
            // Analyze geometry
            const geometry = analyzeGeometry(bodyPoints);
            
            // Calculate Vitruvian score
            const vitruvianScore = calculateVitruvianScore(proportions, geometry);
            
            return {
                vitruvian_score: vitruvianScore,
                proportions: proportions,
                geometry: geometry,
                analysis: generateAnalysis(vitruvianScore, proportions, geometry)
            };
        }

        function extractBodyPoints(keypoints) {
            const points = {};
            const keyMapping = {
                'nose': 0, 'leftEye': 1, 'rightEye': 2,
                'leftEar': 3, 'rightEar': 4,
                'leftShoulder': 5, 'rightShoulder': 6,
                'leftElbow': 7, 'rightElbow': 8,
                'leftWrist': 9, 'rightWrist': 10,
                'leftHip': 11, 'rightHip': 12,
                'leftKnee': 13, 'rightKnee': 14,
                'leftAnkle': 15, 'rightAnkle': 16
            };

            for (const [name, index] of Object.entries(keyMapping)) {
                if (keypoints[index] && keypoints[index].score > 0.3) {
                    points[name] = {
                        x: keypoints[index].position.x,
                        y: keypoints[index].position.y,
                        confidence: keypoints[index].score
                    };
                }
            }

            return points;
        }

        function calculateProportions(points) {
            // Calculate head length (approximation from nose to shoulder center)
            const shoulderCenter = {
                x: (points.leftShoulder?.x + points.rightShoulder?.x) / 2,
                y: (points.leftShoulder?.y + points.rightShoulder?.y) / 2
            };

            const headLength = distance(points.nose, shoulderCenter);

            // Calculate total height (nose to ankle center)
            const ankleCenter = {
                x: (points.leftAnkle?.x + points.rightAnkle?.x) / 2,
                y: (points.leftAnkle?.y + points.rightAnkle?.y) / 2
            };

            const totalHeight = Math.abs(points.nose?.y - ankleCenter.y);

            // Calculate arm span
            const armSpan = distance(points.leftWrist, points.rightWrist);

            // Calculate torso length
            const hipCenter = {
                x: (points.leftHip?.x + points.rightHip?.x) / 2,
                y: (points.leftHip?.y + points.rightHip?.y) / 2
            };

            const torsoLength = distance(shoulderCenter, hipCenter);

            // Calculate leg length
            const legLength = distance(hipCenter, ankleCenter);

            return {
                head_to_total_ratio: totalHeight > 0 ? headLength / totalHeight : 0,
                arm_span_to_height_ratio: totalHeight > 0 ? armSpan / totalHeight : 0,
                torso_to_total_ratio: totalHeight > 0 ? torsoLength / totalHeight : 0,
                leg_to_total_ratio: totalHeight > 0 ? legLength / totalHeight : 0,
                measurements: {
                    head_length: headLength,
                    total_height: totalHeight,
                    arm_span: armSpan,
                    torso_length: torsoLength,
                    leg_length: legLength
                }
            };
        }

        function analyzeGeometry(points) {
            // Calculate body center
            const allPoints = Object.values(points).filter(p => p && p.x && p.y);
            const centerX = allPoints.reduce((sum, p) => sum + p.x, 0) / allPoints.length;
            const centerY = allPoints.reduce((sum, p) => sum + p.y, 0) / allPoints.length;

            // Calculate bounding box
            const xCoords = allPoints.map(p => p.x);
            const yCoords = allPoints.map(p => p.y);
            const width = Math.max(...xCoords) - Math.min(...xCoords);
            const height = Math.max(...yCoords) - Math.min(...yCoords);

            // Square ratio
            const squareRatio = Math.min(width, height) / Math.max(width, height);

            // Simple symmetry calculation
            const leftPoints = ['leftShoulder', 'leftElbow', 'leftWrist', 'leftHip', 'leftKnee', 'leftAnkle'];
            const rightPoints = ['rightShoulder', 'rightElbow', 'rightWrist', 'rightHip', 'rightKnee', 'rightAnkle'];
            
            let symmetrySum = 0;
            let validPairs = 0;

            for (let i = 0; i < leftPoints.length; i++) {
                const leftPoint = points[leftPoints[i]];
                const rightPoint = points[rightPoints[i]];
                
                if (leftPoint && rightPoint) {
                    const leftDist = Math.abs(leftPoint.x - centerX);
                    const rightDist = Math.abs(rightPoint.x - centerX);
                    const totalDist = leftDist + rightDist;
                    
                    if (totalDist > 0) {
                        symmetrySum += 1 - Math.abs(leftDist - rightDist) / totalDist;
                        validPairs++;
                    }
                }
            }

            const symmetryScore = validPairs > 0 ? symmetrySum / validPairs : 0;

            return {
                square_ratio: squareRatio,
                symmetry_score: Math.max(0, symmetryScore),
                bounding_box: { width: width, height: height },
                center_point: { x: centerX, y: centerY }
            };
        }

        function calculateVitruvianScore(proportions, geometry) {
            // Ideal Vitruvian proportions
            const idealHeadRatio = 1/8;
            const idealArmSpanRatio = 1.0;
            const idealTorsoRatio = 0.3;
            const idealLegRatio = 0.5;

            // Score each proportion
            const headScore = Math.max(0, 100 - Math.abs(proportions.head_to_total_ratio - idealHeadRatio) * 800);
            const armSpanScore = Math.max(0, 100 - Math.abs(proportions.arm_span_to_height_ratio - idealArmSpanRatio) * 100);
            const torsoScore = Math.max(0, 100 - Math.abs(proportions.torso_to_total_ratio - idealTorsoRatio) * 300);
            const legScore = Math.max(0, 100 - Math.abs(proportions.leg_to_total_ratio - idealLegRatio) * 200);

            // Geometric scores
            const squareScore = geometry.square_ratio * 100;
            const symmetryScore = geometry.symmetry_score * 100;

            // Weighted average
            const totalScore = (
                headScore * 0.15 +
                armSpanScore * 0.25 +
                torsoScore * 0.15 +
                legScore * 0.15 +
                squareScore * 0.15 +
                symmetryScore * 0.15
            );

            return Math.min(100, Math.max(0, totalScore));
        }

        function generateAnalysis(score, proportions, geometry) {
            let level, levelDescription, masterQuote;
            
            if (score >= 85) {
                level = 'Magnifico';
                levelDescription = 'Extraordinary Renaissance Perfection';
                masterQuote = '"You have achieved what I dreamed - the divine proportion made flesh."';
            } else if (score >= 70) {
                level = 'Eccellente';
                levelDescription = 'Impressive Classical Harmony';
                masterQuote = '"Your form speaks the language of ancient geometry beautifully."';
            } else if (score >= 55) {
                level = 'Buono';
                levelDescription = 'Pleasant Proportional Balance';
                masterQuote = '"I see the seeds of divine mathematics within you."';
            } else if (score >= 40) {
                level = 'Discreto';
                levelDescription = 'Modest Geometric Alignment';
                masterQuote = '"With practice, the golden ratios shall reveal themselves."';
            } else {
                level = 'Novizio';
                levelDescription = 'Beginning Your Proportional Journey';
                masterQuote = '"Every master once stood where you stand now - embrace the learning."';
            }

            let analysis = `✨ RENAISSANCE ANALYSIS ✨\n\n`;
            analysis += `🏛️ Assessment: ${level} - ${levelDescription}\n`;
            analysis += `📊 Divine Score: ${score.toFixed(1)} of 100 Sacred Points\n\n`;
            analysis += `💭 Leonardo whispers: ${masterQuote}\n\n`;
            analysis += `🔍 DETAILED PROPORTIONAL EXAMINATION:\n\n`;

            // Head proportion analysis
            const headRatio = proportions.head_to_total_ratio;
            const headIdeal = 0.125;
            const headDeviation = Math.abs(headRatio - headIdeal);
            
            analysis += `👑 The Crown Measurement (Head to Height):\n`;
            analysis += `   Your ratio: ${headRatio.toFixed(3)} | Renaissance ideal: ${headIdeal.toFixed(3)}\n`;
            if (headDeviation < 0.02) {
                analysis += `   🎯 Perfetto! Your head proportions match da Vinci's golden standard almost exactly.\n`;
            } else if (headDeviation < 0.04) {
                analysis += `   ✨ Molto bene! Your head proportions are very close to the classical ideal.\n`;
            } else if (headDeviation < 0.08) {
                analysis += `   📏 Reasonably proportioned, though deviating slightly from Renaissance perfection.\n`;
            } else {
                analysis += `   📐 Your head proportions differ notably from classical standards - this affects overall harmony.\n`;
            }
            analysis += `\n`;

            // Arm span analysis
            const armSpanRatio = proportions.arm_span_to_height_ratio;
            const armSpanIdeal = 1.0;
            const armSpanDeviation = Math.abs(armSpanRatio - armSpanIdeal);
            
            analysis += `🕊️ The Great Embrace (Arm Span to Height):\n`;
            analysis += `   Your ratio: ${armSpanRatio.toFixed(3)} | Renaissance ideal: ${armSpanIdeal.toFixed(3)}\n`;
            if (armSpanDeviation < 0.05) {
                analysis += `   🎯 Magnifico! You embody the perfect square-circle harmony that fascinated Leonardo.\n`;
            } else if (armSpanDeviation < 0.1) {
                analysis += `   ✨ Excellent! Your arm span creates beautiful geometric balance.\n`;
            } else if (armSpanDeviation < 0.2) {
                analysis += `   📏 Good proportions, though not quite achieving perfect geometric unity.\n`;
            } else {
                analysis += `   📐 Your arm span suggests a different body architecture than the classical ideal.\n`;
            }
            analysis += `\n`;

            // Symmetry analysis
            const symmetryScore = geometry.symmetry_score;
            
            analysis += `⚖️ Divine Symmetry (Bilateral Harmony):\n`;
            analysis += `   Your balance: ${symmetryScore.toFixed(3)} | Perfect symmetry: 1.000\n`;
            if (symmetryScore > 0.9) {
                analysis += `   🎯 Straordinario! Your left and right sides mirror each other like a Renaissance masterpiece.\n`;
            } else if (symmetryScore > 0.8) {
                analysis += `   ✨ Beautiful bilateral balance - the mark of natural human grace.\n`;
            } else if (symmetryScore > 0.6) {
                analysis += `   📏 Decent symmetry with some natural human asymmetry showing through.\n`;
            } else {
                analysis += `   📐 Notable asymmetry - perhaps try centering your pose for better balance.\n`;
            }
            analysis += `\n`;

            // Square fit analysis
            const squareRatio = geometry.square_ratio;
            
            analysis += `⬜ Geometric Perfection (Square Harmony):\n`;
            analysis += `   Your fit: ${squareRatio.toFixed(3)} | Perfect square: 1.000\n`;
            if (squareRatio > 0.9) {
                analysis += `   🎯 Incredibile! You fit within the sacred square like da Vinci's original drawing.\n`;
            } else if (squareRatio > 0.8) {
                analysis += `   ✨ Excellent geometric form - your pose speaks pure mathematical beauty.\n`;
            } else if (squareRatio > 0.6) {
                analysis += `   📏 Good overall shape, though not quite achieving perfect geometric containment.\n`;
            } else {
                analysis += `   📐 Your pose extends beyond classical geometric boundaries - try a more centered stance.\n`;
            }
            analysis += `\n`;

            // Overall guidance
            analysis += `🌟 RENAISSANCE GUIDANCE:\n`;
            if (score >= 80) {
                analysis += `You have achieved remarkable harmony with the ancient ideals of human perfection. Leonardo himself would marvel at your natural embodiment of divine proportion. You are living geometry!`;
            } else if (score >= 60) {
                analysis += `Your form carries the noble bearing of Renaissance ideals. With minor adjustments to your pose and alignment, you could achieve even greater harmony with the classical standards.`;
            } else if (score >= 40) {
                analysis += `You show promise in understanding the geometric principles of beauty. Focus on centering your pose, extending your arms fully, and maintaining perfect vertical alignment to improve your score.`;
            } else {
                analysis += `Remember, even Michelangelo's David required countless hours of careful proportion planning. Try standing tall, arms outstretched, perfectly centered, and let the ancient mathematics guide your form.`;
            }

            return analysis;
        }

        function distance(p1, p2) {
            if (!p1 || !p2) return 0;
            return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
        }

        function showLoading() {
            document.querySelector('.upload-section').style.display = 'none';
            document.getElementById('analysisSection').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            hideError();
        }

        function displayResults(data) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('analysisSection').style.display = 'block';

            // Update score
            const score = Math.round(data.vitruvian_score);
            document.getElementById('scoreValue').textContent = score;

            // Update score level
            let level = 'Poor';
            if (score >= 80) level = 'Excellent';
            else if (score >= 60) level = 'Good';
            else if (score >= 40) level = 'Fair';

            document.getElementById('scoreLevel').textContent = level;

            // Update metrics with animations
            setTimeout(() => {
                updateMetric('headRatio', data.proportions.head_to_total_ratio, 0.125);
                updateMetric('armSpan', data.proportions.arm_span_to_height_ratio, 1.0);
                updateMetric('symmetry', data.geometry.symmetry_score, 1.0);
                updateMetric('squareFit', data.geometry.square_ratio, 1.0);
            }, 300);

            // Update analysis text
            document.getElementById('analysisText').textContent = data.analysis;
        }

        function updateMetric(elementId, value, ideal) {
            const fillElement = document.getElementById(elementId);
            const textElement = document.getElementById(elementId + 'Text');

            // Calculate percentage for display
            let percentage = Math.min(100, (value / Math.max(ideal, 1)) * 100);
            if (ideal === 1.0) {
                percentage = value * 100;
            }

            // Animate the fill
            fillElement.style.width = percentage + '%';

            // Update text
            textElement.textContent = value.toFixed(3);

            // Color coding based on how close to ideal
            const deviation = Math.abs(value - ideal);
            let color = '#28a745'; // Green for good
            if (deviation > ideal * 0.2) color = '#ffc107'; // Yellow for okay
            if (deviation > ideal * 0.4) color = '#dc3545'; // Red for poor

            fillElement.style.background = color;
        }

        function resetAnalysis() {
            document.getElementById('imageInput').value = '';
            document.querySelector('.upload-section').style.display = 'block';
            document.getElementById('analysisSection').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
            hideError();

            // Reset metrics
            const metrics = ['headRatio', 'armSpan', 'symmetry', 'squareFit'];
            metrics.forEach(metric => {
                document.getElementById(metric).style.width = '0%';
                document.getElementById(metric + 'Text').textContent = '--';
            });

            // Reset score
            document.getElementById('scoreValue').textContent = '--';
            document.getElementById('scoreLevel').textContent = 'Analyzing...';
            document.getElementById('analysisText').textContent = '';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            // Hide loading and analysis sections
            document.getElementById('loading').style.display = 'none';
            document.getElementById('analysisSection').style.display = 'none';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>
</body>
</html>