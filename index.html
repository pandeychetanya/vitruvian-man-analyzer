<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vitruvian Man Analyzer - Renaissance Art History</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;700;900&family=Libre+Baskerville:wght@400;700&family=Cinzel+Decorative:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Libre Baskerville', serif;
            line-height: 1.8;
            color: #3a2f2a;
            background: #f9f6f0;
            position: relative;
            overflow-x: hidden;
        }

        /* Artistic background with old paper texture */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(218, 165, 32, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(160, 82, 45, 0.08) 0%, transparent 50%),
                linear-gradient(135deg, #f9f6f0 0%, #f4f0e8 25%, #ede6d6 50%, #f7f3eb 75%, #f9f6f0 100%);
            z-index: -2;
        }

        /* Subtle manuscript texture */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 1px 1px, rgba(218, 165, 32, 0.15) 1px, transparent 0);
            background-size: 20px 20px;
            opacity: 0.3;
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Elegant header */
        header {
            text-align: center;
            margin-bottom: 60px;
            padding: 60px 0;
            position: relative;
            background: linear-gradient(135deg, 
                rgba(218, 165, 32, 0.05) 0%, 
                rgba(255, 255, 255, 0.8) 30%, 
                rgba(160, 82, 45, 0.05) 100%
            );
            border-radius: 30px;
            border: 2px solid rgba(218, 165, 32, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }

        header::before {
            content: '✦';
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2em;
            color: #daa520;
            opacity: 0.6;
        }

        header::after {
            content: '✦';
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2em;
            color: #daa520;
            opacity: 0.6;
        }

        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 4rem;
            font-weight: 900;
            color: #8b4513;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            letter-spacing: 2px;
        }

        .subtitle {
            font-family: 'Cinzel Decorative', serif;
            font-size: 1.5rem;
            color: #a0522d;
            margin-bottom: 15px;
            font-weight: 400;
        }

        .description {
            font-size: 1.2rem;
            color: #6b4423;
            max-width: 600px;
            margin: 0 auto;
            font-style: italic;
        }

        /* Beautiful main content area */
        main {
            background: linear-gradient(145deg, 
                rgba(255, 255, 255, 0.9) 0%, 
                rgba(249, 246, 240, 0.95) 50%, 
                rgba(255, 255, 255, 0.9) 100%
            );
            border-radius: 25px;
            padding: 60px;
            margin-bottom: 40px;
            box-shadow: 
                0 30px 80px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(218, 165, 32, 0.15);
            position: relative;
        }

        main::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                #daa520 20%, 
                #cd853f 50%, 
                #daa520 80%, 
                transparent 100%
            );
            border-radius: 25px 25px 0 0;
        }

        /* Upload section styling */
        .upload-section {
            margin-bottom: 50px;
        }

        .upload-area {
            border: 3px dashed #cd853f;
            border-radius: 20px;
            padding: 80px 60px;
            text-align: center;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.7) 0%, 
                rgba(255, 248, 240, 0.9) 50%, 
                rgba(255, 255, 255, 0.7) 100%
            );
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, 
                rgba(218, 165, 32, 0.1) 0%, 
                transparent 70%
            );
            transform: scale(0);
            transition: transform 0.6s ease;
        }

        .upload-area:hover::before {
            transform: scale(1);
        }

        .upload-area:hover {
            border-color: #daa520;
            background: linear-gradient(135deg, 
                rgba(255, 248, 240, 0.95) 0%, 
                rgba(255, 255, 255, 0.9) 50%, 
                rgba(255, 248, 240, 0.95) 100%
            );
            transform: translateY(-8px);
            box-shadow: 0 25px 50px rgba(139, 69, 19, 0.15);
        }

        .upload-area.dragover {
            border-color: #b8860b;
            background: linear-gradient(135deg, 
                rgba(218, 165, 32, 0.1) 0%, 
                rgba(255, 248, 240, 0.95) 50%, 
                rgba(218, 165, 32, 0.1) 100%
            );
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 6rem;
            color: #cd853f;
            margin-bottom: 30px;
            display: block;
        }

        .upload-content p {
            font-size: 1.4rem;
            color: #6b4423;
            margin-bottom: 30px;
            font-weight: 400;
        }

        .upload-btn {
            background: linear-gradient(135deg, #daa520 0%, #cd853f 50%, #b8860b 100%);
            color: white;
            border: none;
            padding: 20px 50px;
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.4s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .upload-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.4) 50%, 
                transparent 100%
            );
            transition: left 0.6s ease;
        }

        .upload-btn:hover::before {
            left: 100%;
        }

        .upload-btn:hover {
            background: linear-gradient(135deg, #f4d03f 0%, #e6b800 50%, #d4a300 100%);
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(218, 165, 32, 0.4);
        }

        /* Analysis section */
        .analysis-section {
            display: grid;
            grid-template-columns: 1fr 1.3fr;
            gap: 60px;
            align-items: start;
        }

        .image-preview {
            position: relative;
        }

        .image-preview img {
            width: 100%;
            height: auto;
            border-radius: 20px;
            border: 4px solid #daa520;
            box-shadow: 
                0 25px 50px rgba(139, 69, 19, 0.2),
                inset 0 0 0 2px rgba(255, 255, 255, 0.5);
        }

        .image-preview::before {
            content: '';
            position: absolute;
            top: -15px;
            left: -15px;
            right: -15px;
            bottom: -15px;
            background: linear-gradient(45deg, 
                #daa520, #cd853f, #daa520, #b8860b
            );
            background-size: 400% 400%;
            border-radius: 25px;
            z-index: -1;
            opacity: 0.3;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .results {
            display: flex;
            flex-direction: column;
            gap: 40px;
        }

        /* Score display */
        .score-display {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, 
                rgba(218, 165, 32, 0.08) 0%, 
                rgba(255, 255, 255, 0.9) 50%, 
                rgba(205, 133, 63, 0.08) 100%
            );
            border-radius: 25px;
            border: 2px solid rgba(218, 165, 32, 0.2);
            box-shadow: 0 15px 40px rgba(139, 69, 19, 0.1);
        }

        .score-circle {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: linear-gradient(135deg, #daa520 0%, #cd853f 50%, #b8860b 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            color: white;
            position: relative;
            box-shadow: 
                0 20px 40px rgba(139, 69, 19, 0.3),
                inset 0 4px 8px rgba(255, 255, 255, 0.2);
        }

        .score-circle::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
        }

        .score-circle span {
            font-family: 'Playfair Display', serif;
            font-size: 2.8rem;
            font-weight: 900;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .score-circle small {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 5px;
        }

        #scoreLevel {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 700;
            color: #8b4513;
            margin-bottom: 15px;
        }

        .score-description {
            font-size: 1.1rem;
            color: #6b4423;
            font-style: italic;
        }

        /* Metrics styling */
        .metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            padding: 40px;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.9) 0%, 
                rgba(249, 246, 240, 0.95) 50%, 
                rgba(255, 255, 255, 0.9) 100%
            );
            border-radius: 20px;
            border: 1px solid rgba(218, 165, 32, 0.15);
            box-shadow: 0 10px 30px rgba(139, 69, 19, 0.1);
        }

        .metric {
            text-align: center;
            padding: 25px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 15px;
            border: 1px solid rgba(218, 165, 32, 0.1);
            transition: transform 0.3s ease;
        }

        .metric:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(139, 69, 19, 0.15);
        }

        .metric-icon {
            font-size: 2.5rem;
            color: #cd853f;
            margin-bottom: 15px;
        }

        .metric label {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: #8b4513;
            display: block;
            margin-bottom: 15px;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #6b4423;
            margin-bottom: 10px;
        }

        .metric-status {
            font-size: 0.95rem;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .excellent {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }

        .good {
            background: rgba(255, 193, 7, 0.1);
            color: #856404;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .fair {
            background: rgba(255, 152, 0, 0.1);
            color: #d39e00;
            border: 1px solid rgba(255, 152, 0, 0.3);
        }

        .needs-work {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        /* Analysis text */
        .analysis-text {
            background: linear-gradient(135deg, 
                rgba(255, 248, 240, 0.9) 0%, 
                rgba(255, 255, 255, 0.95) 50%, 
                rgba(255, 248, 240, 0.9) 100%
            );
            padding: 40px;
            border-radius: 20px;
            border-left: 6px solid #daa520;
            border-top: 1px solid rgba(218, 165, 32, 0.2);
            border-right: 1px solid rgba(218, 165, 32, 0.2);
            border-bottom: 1px solid rgba(218, 165, 32, 0.2);
            font-size: 1.1rem;
            line-height: 1.8;
            color: #4a3626;
            box-shadow: 0 10px 30px rgba(139, 69, 19, 0.1);
        }

        .analysis-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: #8b4513;
            margin-bottom: 20px;
            text-align: center;
        }

        /* New analysis button */
        .new-analysis-btn {
            background: linear-gradient(135deg, #8b4513 0%, #a0522d 50%, #654321 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.4s ease;
            align-self: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .new-analysis-btn:hover {
            background: linear-gradient(135deg, #a0522d 0%, #8b4513 50%, #654321 100%);
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(139, 69, 19, 0.4);
        }

        /* Loading animation */
        .loading {
            text-align: center;
            padding: 100px 50px;
        }

        .spinner {
            width: 80px;
            height: 80px;
            border: 6px solid rgba(218, 165, 32, 0.2);
            border-top: 6px solid #daa520;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 40px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading p {
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
            color: #8b4513;
            font-style: italic;
        }

        /* Footer */
        footer {
            background: linear-gradient(135deg, 
                rgba(139, 69, 19, 0.9) 0%, 
                rgba(160, 82, 45, 0.95) 50%, 
                rgba(139, 69, 19, 0.9) 100%
            );
            color: #f9f6f0;
            padding: 60px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(139, 69, 19, 0.2);
            margin-top: 40px;
        }

        footer h3 {
            font-family: 'Playfair Display', serif;
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 25px;
            color: #f4d03f;
        }

        footer p {
            font-size: 1.2rem;
            line-height: 1.8;
            max-width: 800px;
            margin: 0 auto;
            opacity: 0.95;
        }

        .error-message {
            background: linear-gradient(135deg, 
                rgba(220, 53, 69, 0.1) 0%, 
                rgba(248, 215, 218, 0.9) 50%, 
                rgba(220, 53, 69, 0.1) 100%
            );
            color: #721c24;
            padding: 25px 30px;
            border-radius: 15px;
            margin: 30px 0;
            border: 1px solid #f5c6cb;
            font-size: 1.1rem;
            box-shadow: 0 10px 25px rgba(220, 53, 69, 0.1);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }
            
            h1 {
                font-size: 2.5rem;
            }
            
            .subtitle {
                font-size: 1.2rem;
            }
            
            main {
                padding: 30px 25px;
            }
            
            .analysis-section {
                grid-template-columns: 1fr;
                gap: 30px;
            }
            
            .metrics {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 25px;
            }
            
            .upload-area {
                padding: 50px 30px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="vitruvian-image">
                <img src="https://upload.wikimedia.org/wikipedia/commons/2/22/Da_Vinci_Vitruve_Luc_Viatour.jpg" alt="Leonardo da Vinci's Vitruvian Man" style="width: 200px; height: 200px; object-fit: cover; border-radius: 50%; border: 4px solid #daa520; box-shadow: 0 15px 30px rgba(139, 69, 19, 0.2); margin-bottom: 30px;">
            </div>
            <h1>Vitruvian Man Analyzer</h1>
            <div class="subtitle">Renaissance Art & Human Proportions</div>
            <p class="description">Discover how your pose compares to Leonardo da Vinci's vision of perfect human harmony</p>
        </header>

        <main>
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-content">
                        <div class="upload-icon">🎨</div>
                        <p>Upload your image to begin the Renaissance analysis</p>
                        <input type="file" id="imageInput" accept="image/*" hidden>
                        <button class="upload-btn" onclick="document.getElementById('imageInput').click()">
                            Choose Your Portrait
                        </button>
                    </div>
                </div>
            </div>

            <div class="analysis-section" id="analysisSection" style="display: none;">
                <div class="image-preview">
                    <img id="previewImage" alt="Your analyzed image">
                </div>
                
                <div class="results">
                    <div class="score-display">
                        <div class="score-circle">
                            <span id="scoreValue">--</span>
                            <small>/100</small>
                        </div>
                        <h3 id="scoreLevel">Analyzing...</h3>
                        <p class="score-description" id="scoreDescription"></p>
                    </div>
                    
                    <div class="metrics">
                        <div class="metric">
                            <div class="metric-icon">👑</div>
                            <label>Head Proportion</label>
                            <div class="metric-value" id="headRatioValue">--</div>
                            <div class="metric-status" id="headRatioStatus">--</div>
                        </div>
                        
                        <div class="metric">
                            <div class="metric-icon">🤲</div>
                            <label>Arm Span</label>
                            <div class="metric-value" id="armSpanValue">--</div>
                            <div class="metric-status" id="armSpanStatus">--</div>
                        </div>
                        
                        <div class="metric">
                            <div class="metric-icon">⚖️</div>
                            <label>Body Symmetry</label>
                            <div class="metric-value" id="symmetryValue">--</div>
                            <div class="metric-status" id="symmetryStatus">--</div>
                        </div>
                        
                        <div class="metric">
                            <div class="metric-icon">⬜</div>
                            <label>Geometric Fit</label>
                            <div class="metric-value" id="squareFitValue">--</div>
                            <div class="metric-status" id="squareFitStatus">--</div>
                        </div>
                    </div>
                    
                    <div class="analysis-text">
                        <div class="analysis-title" id="analysisText">
                            <!-- Simple analysis will be populated here -->
                        </div>
                    </div>
                    
                    <button class="new-analysis-btn" onclick="resetAnalysis()">
                        Analyze Another Portrait
                    </button>
                </div>
            </div>

            <div class="loading" id="loading" style="display: none;">
                <div class="spinner"></div>
                <p>The Renaissance master is examining your proportions...</p>
            </div>

            <div id="errorMessage" class="error-message" style="display: none;">
                <!-- Error messages will appear here -->
            </div>
        </main>

        <footer>
            <h3>About Leonardo's Vision</h3>
            <p>
                The Vitruvian Man represents the Renaissance belief that the human body embodies perfect mathematical proportions. 
                Leonardo da Vinci's masterpiece shows how we fit within both a circle and square, demonstrating the divine geometry 
                found in human form. This analyzer helps you discover how closely your own proportions match these timeless ideals 
                of beauty and harmony.
            </p>
        </footer>
    </div>

    <!-- TensorFlow.js and PoseNet -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet@2.2.2"></script>

    <script>
        let net;
        let isModelLoaded = false;

        // Load PoseNet model
        async function loadModel() {
            try {
                net = await posenet.load({
                    architecture: 'MobileNetV1',
                    outputStride: 16,
                    inputResolution: { width: 640, height: 480 },
                    multiplier: 0.75
                });
                isModelLoaded = true;
                console.log('PoseNet model loaded successfully');
            } catch (error) {
                console.error('Error loading PoseNet model:', error);
                showError('Failed to load AI model. Please refresh the page and try again.');
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadModel();
            setupEventHandlers();
        });

        function setupEventHandlers() {
            const uploadArea = document.getElementById('uploadArea');
            const imageInput = document.getElementById('imageInput');

            uploadArea.addEventListener('click', function() {
                imageInput.click();
            });

            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleImageUpload(files[0]);
                }
            });

            imageInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleImageUpload(e.target.files[0]);
                }
            });
        }

        async function handleImageUpload(file) {
            if (!isModelLoaded) {
                showError('AI model is still loading. Please wait a moment and try again.');
                return;
            }

            if (!file.type.startsWith('image/')) {
                showError('Please select a valid image file.');
                return;
            }

            showLoading();

            try {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                img.onload = async function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    try {
                        const poses = await net.estimateSinglePose(canvas, {
                            flipHorizontal: false
                        });

                        if (poses && poses.keypoints) {
                            const analysis = analyzeVitruvianPose(poses.keypoints, img.width, img.height);
                            displayResults(analysis);
                        } else {
                            throw new Error('No pose detected in the image');
                        }
                    } catch (error) {
                        console.error('Pose estimation error:', error);
                        showError('Could not detect a human pose in this image. Please try with a clearer full-body image.');
                    }
                };

                img.onerror = function() {
                    showError('Could not load the selected image. Please try a different file.');
                };

                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImage').src = e.target.result;
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);

            } catch (error) {
                console.error('Error processing image:', error);
                showError('Error processing the image. Please try again.');
            }
        }

        function analyzeVitruvianPose(keypoints, imageWidth, imageHeight) {
            const bodyPoints = extractBodyPoints(keypoints);
            const proportions = calculateProportions(bodyPoints);
            const geometry = analyzeGeometry(bodyPoints);
            const vitruvianScore = calculateVitruvianScore(proportions, geometry);
            
            return {
                vitruvian_score: vitruvianScore,
                proportions: proportions,
                geometry: geometry,
                analysis: generateSimpleAnalysis(vitruvianScore, proportions, geometry)
            };
        }

        function extractBodyPoints(keypoints) {
            const points = {};
            const keyMapping = {
                'nose': 0, 'leftEye': 1, 'rightEye': 2,
                'leftEar': 3, 'rightEar': 4,
                'leftShoulder': 5, 'rightShoulder': 6,
                'leftElbow': 7, 'rightElbow': 8,
                'leftWrist': 9, 'rightWrist': 10,
                'leftHip': 11, 'rightHip': 12,
                'leftKnee': 13, 'rightKnee': 14,
                'leftAnkle': 15, 'rightAnkle': 16
            };

            for (const [name, index] of Object.entries(keyMapping)) {
                if (keypoints[index] && keypoints[index].score > 0.3) {
                    points[name] = {
                        x: keypoints[index].position.x,
                        y: keypoints[index].position.y,
                        confidence: keypoints[index].score
                    };
                }
            }

            return points;
        }

        function calculateProportions(points) {
            const shoulderCenter = {
                x: (points.leftShoulder?.x + points.rightShoulder?.x) / 2,
                y: (points.leftShoulder?.y + points.rightShoulder?.y) / 2
            };

            const headLength = distance(points.nose, shoulderCenter);

            const ankleCenter = {
                x: (points.leftAnkle?.x + points.rightAnkle?.x) / 2,
                y: (points.leftAnkle?.y + points.rightAnkle?.y) / 2
            };

            const totalHeight = Math.abs(points.nose?.y - ankleCenter.y);
            const armSpan = distance(points.leftWrist, points.rightWrist);

            const hipCenter = {
                x: (points.leftHip?.x + points.rightHip?.x) / 2,
                y: (points.leftHip?.y + points.rightHip?.y) / 2
            };

            const torsoLength = distance(shoulderCenter, hipCenter);
            const legLength = distance(hipCenter, ankleCenter);

            return {
                head_to_total_ratio: totalHeight > 0 ? headLength / totalHeight : 0,
                arm_span_to_height_ratio: totalHeight > 0 ? armSpan / totalHeight : 0,
                torso_to_total_ratio: totalHeight > 0 ? torsoLength / totalHeight : 0,
                leg_to_total_ratio: totalHeight > 0 ? legLength / totalHeight : 0,
                measurements: {
                    head_length: headLength,
                    total_height: totalHeight,
                    arm_span: armSpan,
                    torso_length: torsoLength,
                    leg_length: legLength
                }
            };
        }

        function analyzeGeometry(points) {
            const allPoints = Object.values(points).filter(p => p && p.x && p.y);
            const centerX = allPoints.reduce((sum, p) => sum + p.x, 0) / allPoints.length;
            const centerY = allPoints.reduce((sum, p) => sum + p.y, 0) / allPoints.length;

            const xCoords = allPoints.map(p => p.x);
            const yCoords = allPoints.map(p => p.y);
            const width = Math.max(...xCoords) - Math.min(...xCoords);
            const height = Math.max(...yCoords) - Math.min(...yCoords);

            const squareRatio = Math.min(width, height) / Math.max(width, height);

            const leftPoints = ['leftShoulder', 'leftElbow', 'leftWrist', 'leftHip', 'leftKnee', 'leftAnkle'];
            const rightPoints = ['rightShoulder', 'rightElbow', 'rightWrist', 'rightHip', 'rightKnee', 'rightAnkle'];
            
            let symmetrySum = 0;
            let validPairs = 0;

            for (let i = 0; i < leftPoints.length; i++) {
                const leftPoint = points[leftPoints[i]];
                const rightPoint = points[rightPoints[i]];
                
                if (leftPoint && rightPoint) {
                    const leftDist = Math.abs(leftPoint.x - centerX);
                    const rightDist = Math.abs(rightPoint.x - centerX);
                    const totalDist = leftDist + rightDist;
                    
                    if (totalDist > 0) {
                        symmetrySum += 1 - Math.abs(leftDist - rightDist) / totalDist;
                        validPairs++;
                    }
                }
            }

            const symmetryScore = validPairs > 0 ? symmetrySum / validPairs : 0;

            return {
                square_ratio: squareRatio,
                symmetry_score: Math.max(0, symmetryScore),
                bounding_box: { width: width, height: height },
                center_point: { x: centerX, y: centerY }
            };
        }

        function calculateVitruvianScore(proportions, geometry) {
            const idealHeadRatio = 1/8;
            const idealArmSpanRatio = 1.0;
            const idealTorsoRatio = 0.3;
            const idealLegRatio = 0.5;

            const headScore = Math.max(0, 100 - Math.abs(proportions.head_to_total_ratio - idealHeadRatio) * 800);
            const armSpanScore = Math.max(0, 100 - Math.abs(proportions.arm_span_to_height_ratio - idealArmSpanRatio) * 100);
            const torsoScore = Math.max(0, 100 - Math.abs(proportions.torso_to_total_ratio - idealTorsoRatio) * 300);
            const legScore = Math.max(0, 100 - Math.abs(proportions.leg_to_total_ratio - idealLegRatio) * 200);

            const squareScore = geometry.square_ratio * 100;
            const symmetryScore = geometry.symmetry_score * 100;

            const totalScore = (
                headScore * 0.15 +
                armSpanScore * 0.25 +
                torsoScore * 0.15 +
                legScore * 0.15 +
                squareScore * 0.15 +
                symmetryScore * 0.15
            );

            return Math.min(100, Math.max(0, totalScore));
        }

        function generateSimpleAnalysis(score, proportions, geometry) {
            let analysis = "";

            if (score >= 85) {
                analysis = "🎨 Extraordinary Renaissance perfection!";
            } else if (score >= 70) {
                analysis = "✨ Excellent classical proportions!";
            } else if (score >= 55) {
                analysis = "👍 Good proportional harmony!";
            } else if (score >= 40) {
                analysis = "📏 Fair geometric alignment.";
            } else {
                analysis = "🌱 Beginning proportional journey.";
            }

            return analysis;
        }

        function distance(p1, p2) {
            if (!p1 || !p2) return 0;
            return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
        }

        function displayResults(data) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('analysisSection').style.display = 'block';

            // Update score
            const score = Math.round(data.vitruvian_score);
            document.getElementById('scoreValue').textContent = score;

            // Update score level and description
            let level, description;
            if (score >= 85) {
                level = 'Renaissance Master';
                description = 'Extraordinary proportional harmony';
            } else if (score >= 70) {
                level = 'Classical Beauty';
                description = 'Excellent geometric balance';
            } else if (score >= 55) {
                level = 'Harmonious Form';
                description = 'Good proportional alignment';
            } else if (score >= 40) {
                level = 'Developing Grace';
                description = 'Promising proportional foundation';
            } else {
                level = 'Artistic Beginning';
                description = 'Starting your proportional journey';
            }

            document.getElementById('scoreLevel').textContent = level;
            document.getElementById('scoreDescription').textContent = description;

            // Update metrics
            updateMetricDisplay('headRatio', data.proportions.head_to_total_ratio, 0.125, 'Head proportion');
            updateMetricDisplay('armSpan', data.proportions.arm_span_to_height_ratio, 1.0, 'Arm span ratio');
            updateMetricDisplay('symmetry', data.geometry.symmetry_score, 1.0, 'Symmetry score');
            updateMetricDisplay('squareFit', data.geometry.square_ratio, 1.0, 'Square fit ratio');

            // Update analysis text
            document.getElementById('analysisText').textContent = data.analysis;
        }

        function updateMetricDisplay(metricId, value, ideal, label) {
            const deviation = Math.abs(value - ideal) / ideal;
            let status, statusClass;

            if (deviation < 0.1) {
                status = 'Excellent';
                statusClass = 'excellent';
            } else if (deviation < 0.2) {
                status = 'Good';
                statusClass = 'good';
            } else if (deviation < 0.4) {
                status = 'Fair';
                statusClass = 'fair';
            } else {
                status = 'Needs Work';
                statusClass = 'needs-work';
            }

            document.getElementById(metricId + 'Value').textContent = value.toFixed(3);
            const statusElement = document.getElementById(metricId + 'Status');
            statusElement.textContent = status;
            statusElement.className = 'metric-status ' + statusClass;
        }

        function showLoading() {
            document.querySelector('.upload-section').style.display = 'none';
            document.getElementById('analysisSection').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            hideError();
        }

        function resetAnalysis() {
            document.getElementById('imageInput').value = '';
            document.querySelector('.upload-section').style.display = 'block';
            document.getElementById('analysisSection').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
            hideError();
            
            // Reset analysis text
            document.getElementById('analysisText').textContent = '';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('analysisSection').style.display = 'none';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>
</body>
</html>